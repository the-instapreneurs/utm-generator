<script>
    /**
   * UTM Generator - Tour Functionality
   * Version: 1.3.0
   * Last Updated: ${new Date().toISOString().split('T')[0]}
   */

    console.log(`%c UTM Generator Tour v1.3.0 initialized`, 'background: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');

    document.addEventListener('DOMContentLoaded', function () {
        // Create driver instance
        const tourDriver = driver.js.driver({
            animate: true,
            showProgress: true,
            showButtons: ['next', 'previous', 'close'],
            steps: [
                {
                    element: '[data-utm-input="website-url"]',
                    popover: {
                        title: getTourText('tour.steps.websiteUrl.title', 'Website URL'),
                        description: getTourText('tour.steps.websiteUrl.description', 'Start by entering the website URL you want to track. This is the destination where users will land.'),
                        side: 'right',
                        align: 'start'
                    }
                },
                {
                    element: '.language-switcher',
                    popover: {
                        title: getTourText('tour.steps.languageSwitcher.title', 'Language Selection'),
                        description: getTourText('tour.steps.languageSwitcher.description', 'Choose your preferred language. Your selection will be saved for future visits.'),
                        side: 'bottom',
                        align: 'center'
                    }
                },
                {
                    element: '[data-utm-input="campaign-source"]',
                    popover: {
                        title: getTourText('tour.steps.campaignSource.title', 'Campaign Source'),
                        description: getTourText('tour.steps.campaignSource.description', 'This required field identifies where the traffic is coming from (e.g., google, facebook, newsletter).'),
                        side: 'right',
                        align: 'start'
                    }
                },
                {
                    element: '[data-utm-input="campaign-medium"]',
                    popover: {
                        title: getTourText('tour.steps.campaignMedium.title', 'Campaign Medium'),
                        description: getTourText('tour.steps.campaignMedium.description', 'This required field identifies the marketing medium (e.g., cpc, banner, email).'),
                        side: 'right',
                        align: 'start'
                    }
                },
                {
                    element: '.hint-buttons:first-of-type',
                    popover: {
                        title: getTourText('tour.steps.hints.title', 'Quick Hints'),
                        description: getTourText('tour.steps.hints.description', 'Click these buttons to quickly fill in common values for each field.'),
                        side: 'bottom',
                        align: 'center'
                    }
                },
                {
                    element: '[data-utm-input="campaign-name"]',
                    popover: {
                        title: getTourText('tour.steps.campaignName.title', 'Campaign Name'),
                        description: getTourText('tour.steps.campaignName.description', 'Optional: The name of your marketing campaign (e.g., spring_sale, product_launch).'),
                        side: 'left',
                        align: 'start'
                    }
                },
                {
                    element: '[data-utm-output]',
                    popover: {
                        title: getTourText('tour.steps.output.title', 'Generated URL'),
                        description: getTourText('tour.steps.output.description', 'Your UTM URL will appear here. Click the Copy button to copy it to your clipboard.'),
                        side: 'bottom',
                        align: 'center'
                    }
                },
                {
                    element: '[data-utm-list="history"]',
                    popover: {
                        title: getTourText('tour.steps.history.title', 'URL History'),
                        description: getTourText('tour.steps.history.description', 'Your previously generated URLs are saved here. You can apply them to the form, copy them, or delete them.'),
                        side: 'top',
                        align: 'center'
                    }
                }
            ]
        });

        // Helper function to get tour text with translation support
        function getTourText(key, fallback) {
            if (typeof utmLanguageManager !== 'undefined') {
                const translated = utmLanguageManager.translate(key);
                if (translated && translated !== key) {
                    return translated;
                }
            }
            return fallback;
        }

        // Show tour modal if first time visiting
        const hasVisitedBefore = localStorage.getItem('utmTourShown');
        const tutorialModal = document.getElementById('tutorialModal');
        const tourButton = document.getElementById('tourButton');

        if (!hasVisitedBefore && tutorialModal) {
            tutorialModal.classList.remove('hidden');
        } else if (tourButton) {
            tourButton.classList.remove('hidden');
        }

        // Handle tour button click
        if (tourButton) {
            tourButton.addEventListener('click', function () {
                tourDriver.drive();
            });
        }

        // Handle start tour button click
        const startTourBtn = document.getElementById('startTour');
        if (startTourBtn) {
            startTourBtn.addEventListener('click', function () {
                tutorialModal.classList.add('hidden');
                tourButton.classList.remove('hidden');
                localStorage.setItem('utmTourShown', 'true');
                tourDriver.drive();
            });
        }

        // Handle decline tour button click
        const declineTourBtn = document.getElementById('declineTour');
        if (declineTourBtn) {
            declineTourBtn.addEventListener('click', function () {
                tutorialModal.classList.add('hidden');
                tourButton.classList.remove('hidden');
                localStorage.setItem('utmTourShown', 'true');
            });
        }

        // Listen for language changes to update tour content
        window.addEventListener('utmLanguageChanged', function (e) {
            // Recreate the driver with translated content
            tourDriver.setConfig({
                steps: tourDriver.getConfig().steps.map(step => {
                    const element = step.element;
                    const side = step.popover.side;
                    const align = step.popover.align;

                    // Find the original step to get the translation key
                    const originalStep = findOriginalStep(element);
                    if (originalStep) {
                        const titleKey = `tour.steps.${originalStep}.title`;
                        const descriptionKey = `tour.steps.${originalStep}.description`;

                        return {
                            element,
                            popover: {
                                title: getTourText(titleKey, step.popover.title),
                                description: getTourText(descriptionKey, step.popover.description),
                                side,
                                align
                            }
                        };
                    }
                    return step;
                })
            });
        });

        // Helper to find the original step name based on element selector
        function findOriginalStep(elementSelector) {
            const stepMapping = {
                '[data-utm-input="website-url"]': 'websiteUrl',
                '.language-switcher': 'languageSwitcher',
                '[data-utm-input="campaign-source"]': 'campaignSource',
                '[data-utm-input="campaign-medium"]': 'campaignMedium',
                '.hint-buttons:first-of-type': 'hints',
                '[data-utm-input="campaign-name"]': 'campaignName',
                '[data-utm-output]': 'output',
                '[data-utm-list="history"]': 'history'
            };
            return stepMapping[elementSelector];
        }
    }); 
</script>