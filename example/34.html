<script>
    /**
   * UTM Generator - Language Manager
   * Version: 1.0.0
   */

    class LanguageManager {
        constructor() {
            this.defaultLanguage = 'uk';
            this.availableLanguages = ['uk', 'en', 'pl'];
            this.storageKey = 'utmLanguagePreference';
            this.currentLanguage = this.getLanguagePreference();
            this.translations = {};
            this.initTranslations();
        }

        /**
         * Initialize available translations
         */
        initTranslations() {
            // Translations are loaded from separate files
            if (typeof UTM_TRANSLATIONS_UK !== 'undefined') {
                this.translations.uk = UTM_TRANSLATIONS_UK;
            }
            if (typeof UTM_TRANSLATIONS_EN !== 'undefined') {
                this.translations.en = UTM_TRANSLATIONS_EN;
            }
            if (typeof UTM_TRANSLATIONS_PL !== 'undefined') {
                this.translations.pl = UTM_TRANSLATIONS_PL;
            }
        }

        /**
         * Get user's language preference from localStorage or default to browser language
         */
        getLanguagePreference() {
            const savedLanguage = localStorage.getItem(this.storageKey);

            if (savedLanguage && this.availableLanguages.includes(savedLanguage)) {
                return savedLanguage;
            }

            // Try to detect browser language
            const browserLang = navigator.language.split('-')[0];
            if (this.availableLanguages.includes(browserLang)) {
                return browserLang;
            }

            return this.defaultLanguage;
        }

        /**
         * Save language preference to localStorage
         */
        saveLanguagePreference(language) {
            if (this.availableLanguages.includes(language)) {
                localStorage.setItem(this.storageKey, language);
                this.currentLanguage = language;
                return true;
            }
            return false;
        }

        /**
         * Change language and update UI
         */
        changeLanguage(language) {
            if (this.saveLanguagePreference(language)) {
                this.applyTranslations();
                return true;
            }
            return false;
        }

        /**
         * Get translation for a key
         */
        translate(path) {
            try {
                const keys = path.split('.');
                let result = this.translations[this.currentLanguage];

                for (const key of keys) {
                    if (result[key] === undefined) {
                        console.warn(`[UTM Language Manager] Missing translation for key: ${path} in language: ${this.currentLanguage}`);
                        // Try to fall back to English
                        if (this.currentLanguage !== 'en' && this.translations['en']) {
                            let fallback = this.translations['en'];
                            let found = true;
                            for (const fbKey of keys) {
                                if (fallback[fbKey] === undefined) {
                                    found = false;
                                    break;
                                }
                                fallback = fallback[fbKey];
                            }
                            if (found) {
                                return fallback;
                            }
                        }
                        return path; // Return the key as fallback
                    }
                    result = result[key];
                }
                return result;
            } catch (error) {
                console.error(`[UTM Language Manager] Error translating: ${path}`, error);
                return path;
            }
        }

        /**
         * Apply translations to the entire UI
         */
        applyTranslations() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = this.translate(key);
            });

            // Update all elements with data-i18n-placeholder attribute
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = this.translate(key);
            });

            // Update all tooltips
            document.querySelectorAll('[data-utm-tooltip]').forEach(element => {
                const tooltipKey = element.getAttribute('data-utm-tooltip');

                // Check if we have UTM_CONFIG with tooltip content mapping
                if (window.UTM_CONFIG && window.UTM_CONFIG.tooltips && window.UTM_CONFIG.tooltips.content) {
                    // Get the translation key for this tooltip
                    const translationKey = window.UTM_CONFIG.tooltips.content[tooltipKey];

                    if (translationKey) {
                        // Translate using the proper key
                        const tooltipText = this.translate(translationKey);
                        // Set as title attribute for native browser tooltip as fallback
                        element.setAttribute('title', tooltipText);

                        // Also set data attribute for custom tooltips
                        element.setAttribute('data-tooltip-text', tooltipText);
                    }
                } else {
                    // Fallback to old behavior
                    const fallbackKey = `formFields.${tooltipKey}.tooltip`;
                    const tooltipText = this.translate(fallbackKey);
                    element.setAttribute('title', tooltipText);
                    element.setAttribute('data-tooltip-text', tooltipText);
                }
            });

            // Fire a custom event so other components can update
            window.dispatchEvent(new CustomEvent('utmLanguageChanged', {
                detail: { language: this.currentLanguage }
            }));
        }

        /**
         * Create language switcher UI
         */
        createLanguageSwitcher(targetSelector) {
            const targetElement = document.querySelector(targetSelector);
            if (!targetElement) return;

            const switcherContainer = document.createElement('div');
            switcherContainer.className = 'language-switcher';

            // Create language options
            const languageLabels = {
                uk: 'Українська',
                en: 'English',
                pl: 'Polski'
            };

            this.availableLanguages.forEach(lang => {
                const langButton = document.createElement('button');
                langButton.textContent = languageLabels[lang];
                langButton.className = 'language-button';
                langButton.setAttribute('data-language', lang);
                if (lang === this.currentLanguage) {
                    langButton.classList.add('active');
                }

                langButton.addEventListener('click', () => {
                    if (lang !== this.currentLanguage) {
                        document.querySelectorAll('.language-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        langButton.classList.add('active');
                        this.changeLanguage(lang);
                    }
                });

                switcherContainer.appendChild(langButton);
            });

            targetElement.appendChild(switcherContainer);
        }
    }

    // Global instance
    const utmLanguageManager = new LanguageManager(); 
</script>